{% extends "base.html" %}
{% block title %}Chat | Astro AI{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg border-0 astro-card">
        <div class="card-body d-flex flex-column" style="height: 75vh;">
          <h3 class="text-center shimmer">ðŸ”® Ask Astro AI</h3>
          
          <!-- Chat Messages -->
          <div id="chat-box" class="flex-grow-1 overflow-auto mb-3 p-3 bg-dark rounded" style="min-height:200px;">
            <!-- Messages will appear here -->
          </div>

          <!-- Always Visible Predefined Queries -->
         
          
          <!-- Chat Input -->
          <form id="chat-form" class="d-flex">
            <input type="text" id="chat-input" class="form-control me-2" placeholder="Type your question..." required>
            <button type="submit" class="btn btn-warning">Send</button>
          </form>
           <div id="query-section" style="overflow:auto;" class="mb-3">
            <h6 class="text-muted">Quick Questions:</h6>
            <div class="d-flex flex-wrap gap-2" id="predefined-queries"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");
  const chatBox = document.getElementById("chat-box");
  const queryContainer = document.getElementById("predefined-queries");

  // Predefined queries (merged by category)
  const predefinedQueries = {
    "Daily": [
      "What does my horoscope say for today?",
      "How will this week go for me?",
      "Give me predictions for this month."
    ],
    "Love": [
      "Will I find true love this year?",
      "Is my partner compatible with me?",
      "How will my marriage life be?"
    ],
    "Career": [
      "Will I get a promotion this year?",
      "Is this a good time to change jobs?",
      "What career path suits my horoscope?"
    ],
    "Health": [
      "What does my horoscope say about my health?",
      "Am I prone to stress or anxiety?",
      "Which period should I be cautious about health?"
    ]
  };

  // Render queries as pill buttons with category label
  Object.keys(predefinedQueries).forEach(category => {
    const label = document.createElement("div");
    label.className = "w-100 mt-2 fw-bold text-secondary";
    label.innerText = category;
    queryContainer.appendChild(label);

    predefinedQueries[category].forEach(q => {
      const btn = document.createElement("button");
      btn.className = "btn btn-outline-dark btn-sm rounded-pill";
      btn.innerText = q;
      btn.onclick = (e) => {
        e.preventDefault();
        input.value = q;
        form.dispatchEvent(new Event("submit"));
      };
      queryContainer.appendChild(btn);
    });
  });

  // Chat submission
  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    // User bubble
    chatBox.innerHTML += `
      <div class="d-flex justify-content-end mb-2">
        <div class="p-2 bg-primary text-white rounded" style="max-width:70%;">${message}</div>
      </div>`;
    input.value = "";

    // API call
    const response = await fetch("{% url 'chat_api' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ message }),
    });

    const data = await response.json();
    let reply = data.reply
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\n/g, "<br>")
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

    // AI bubble
    chatBox.innerHTML += `
      <div class="d-flex justify-content-start mb-2">
        <div class="p-2 bg-success text-white rounded" style="max-width:70%;">${reply}</div>
      </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  });
});
</script>
{% endblock %}
