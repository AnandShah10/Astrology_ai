{% extends "base.html" %}
{% block title %}Chat | Astro AI{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg border-0 astro-card">
        <div class="card-body d-flex flex-column" style="height: 75vh;">
          <h3 class="text-center shimmer">ðŸ”® Ask Astro AI</h3>
          
          <!-- Chat Messages -->
          <div id="chat-box" class="flex-grow-1 overflow-auto mb-3 p-3 bg-dark rounded" style="min-height:200px;">
            <!-- Messages will appear here -->
          </div>

          <!-- Chat Input + Voice -->
          <form id="chat-form" class="d-flex align-items-center">
            <input type="text" id="chat-input" class="form-control me-2" placeholder="Type or speak your question..." required>
            
            <!-- Voice Button -->
            <button type="button" id="voice-btn" class="btn btn-light rounded-circle" style="width:45px;height:45px;">
              <i class="bi bi-mic" id='voice-icon'></i>
            </button>

            <button type="submit" class="btn btn-warning ms-2">Send</button>
          </form>

          <!-- Predefined Queries -->
          <div id="query-section" style="overflow:auto;" class="mt-3">
            <h6 class="text-muted">Quick Questions:</h6>
            <div class="d-flex flex-wrap gap-2" id="predefined-queries"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-input");
  const chatBox = document.getElementById("chat-box");
  const queryContainer = document.getElementById("predefined-queries");
  const voiceBtn = document.getElementById("voice-btn");
  const micIcon = document.getElementById("voice-icon");

  // -------------------
  // Predefined Queries
  // -------------------
  const predefinedQueries = {
    "Daily": ["What does my horoscope say for today?","How will this week go for me?","Give me predictions for this month."],
    "Love": ["Will I find true love this year?","Is my partner compatible with me?","How will my marriage life be?"],
    "Career": ["Will I get a promotion this year?","Is this a good time to change jobs?","What career path suits my horoscope?"],
    "Health": ["What does my horoscope say about my health?","Am I prone to stress or anxiety?","Which period should I be cautious about health?"]
  };

  Object.keys(predefinedQueries).forEach(category => {
    const label = document.createElement("div");
    label.className = "w-100 mt-2 fw-bold text-secondary";
    label.innerText = category;
    queryContainer.appendChild(label);

    predefinedQueries[category].forEach(q => {
      const btn = document.createElement("button");
      btn.className = "btn btn-outline-dark btn-sm rounded-pill";
      btn.innerText = q;
      btn.onclick = (e) => {
        e.preventDefault();
        input.value = q;
        form.dispatchEvent(new Event("submit"));
      };
      queryContainer.appendChild(btn);
    });
  });

  // -------------------
  // Chat Submission (Text)
  // -------------------
  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    addUserBubble(message);
    input.value = "";

    const response = await fetch("{% url 'chat_api' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ message }),
    });

    const data = await response.json();
    addAIBubble(data.reply);

    if (data.audio) {
      playAudio(data.audio);
    }
  });

   // -------------------
  // Voice via WebSocket
  // -------------------
  const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
  const wsPath = `${wsScheme}://${window.location.host}/ws/voice/`;
  const ws = new WebSocket(wsPath);

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log(data)
    if (data.transcript) addUserBubble(data.transcript); // partial transcript
    if (data.reply) addAIBubble(data.reply);             // AI text
    if (data.audio) playAudio(data.audio); 
  };

  let mediaRecorder;
  function startRecording() {
          console.log("Recording Started...........................")

    navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
      mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

      mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
          console.log(event.data,'--------------------------------------')
          ws.send(event.data);
        }
      };

      mediaRecorder.start(250); // send chunks every 250ms

      micIcon.classList.remove("bi-mic");
      micIcon.classList.add("bi-mic-fill");
      voiceBtn.classList.add("btn-danger");
    });
  }

  function stopRecording() {
    console.log("Recording stopped ....................................")
    if (!mediaRecorder) return;
    mediaRecorder.stop();

    micIcon.classList.remove("bi-mic-fill");
    micIcon.classList.add("bi-mic");
    voiceBtn.classList.remove("btn-danger");

    // Tell backend recording is done
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({ "action": "stop" }));
    }
  }

  // Desktop events
  voiceBtn.addEventListener("mousedown", startRecording);
  voiceBtn.addEventListener("mouseup", stopRecording);

  // Mobile touch events
  voiceBtn.addEventListener("touchstart", (e) => { e.preventDefault(); startRecording(); });
  voiceBtn.addEventListener("touchend", (e) => { e.preventDefault(); stopRecording(); });

  // -------------------
  // Helper Functions
  // -------------------
  function addUserBubble(message) {
    chatBox.innerHTML += `
      <div class="d-flex justify-content-end mb-2">
        <div class="p-2 bg-primary text-white rounded" style="max-width:70%;">${message}</div>
      </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function addAIBubble(reply) {
    let formatted = reply
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\n/g, "<br>")
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");

    chatBox.innerHTML += `
      <div class="d-flex justify-content-start mb-2">
        <div class="p-2 bg-success text-white rounded" style="max-width:70%;">${formatted}</div>
      </div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function playAudio(base64Audio) {
    const audio = new Audio("data:audio/mp3;base64," + base64Audio);
    console.log(audio)
    audio.play();
  }
});
</script>

{% endblock %}
