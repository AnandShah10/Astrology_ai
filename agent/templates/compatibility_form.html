{% extends "base.html" %}
{% block title %}Compatibility Report | Astro AI{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-lg border-0">
        <div class="card-body">
          <h3 class="text-center mb-4">üíû Kundali Compatibility</h3>
          
          <!-- Compatibility Form -->
          <form id="compatibility-form" class="row g-3">
            
            <h5 class="mt-3">Person 1</h5>
            <div class="col-md-4">
              <input type="text" name="name1" class="form-control" placeholder="Full Name" required>
            </div>
            <div class="col-md-4">
              <input type="date" name="date1" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="time" name="time1" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="text" name="place1" class="form-control" placeholder="Place" required>
            </div>

            <h5 class="mt-4">Person 2</h5>
            <div class="col-md-4">
              <input type="text" name="name2" class="form-control" placeholder="Full Name" required>
            </div>
            <div class="col-md-4">
              <input type="date" name="date2" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="time" name="time2" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="text" name="place2" class="form-control" placeholder="Place" required>
            </div>

            <div class="col-12 text-center mt-4">
              <button type="submit" class="btn btn-success px-5">Check Compatibility</button>
            </div>
          </form>
          <!-- Loader -->
            <div id="compatibility-loader" class="text-center my-4" style="display:none;">
              <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2 text-dark">üîÆ Calculating compatibility...</p>
            </div>

          <!-- Result -->
          <div id="compatibility-result" class="mt-5"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("compatibility-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const loader = document.getElementById("compatibility-loader");
  const resultBox = document.getElementById("compatibility-result");
  resultBox.innerHTML = "";
  loader.style.display = "block";

  const formData = new FormData(this);
  const payload = Object.fromEntries(formData.entries());

  const person1 = {
    "Name": payload["name1"],
    "Date": payload["date1"],
    "Time": payload["time1"],
    "Place": payload["place1"]
  };
  const person2 = {
    "Name": payload["name2"],
    "Date": payload["date2"],
    "Time": payload["time2"],
    "Place": payload["place2"]
  };

  try {
    const response = await fetch("{% url 'compatibility' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}",
      },
      body: JSON.stringify({ person1, person2 }),
    });

    const data = await response.json();
    console.log(data)
    // Build HTML
    let html = `
      <div class="card shadow border-0 bg-light mb-4">
        <div class="card-body text-center">
          <h4 class="mb-2">‚ú® Overall Compatibility</h4>
          <h5 class="text-success">${data.match_status}</h5>
          <div class="progress my-3" style="height: 25px;">
            <div class="progress-bar bg-success fw-bold" role="progressbar"
              style="width: ${data.total_score}%;"
              aria-valuenow="${data.total_score}" aria-valuemin="0" aria-valuemax="100">
              ${data.total_score}%
            </div>
          </div>
        </div>
      </div>
    `;

    // üü¢ Koota Breakdown
    html += `
      <div class="card shadow border-0 mb-4">
        <div class="card-body">
          <h5 class="mb-3">üìä Koota Breakdown</h5>
          <table class="table table-sm table-bordered">
            <thead class="table-secondary">
              <tr>
                <th>Koota</th>
                <th>Score</th>
                <th>Max Score</th>
              </tr>
            </thead>
            <tbody>
    `;
    for (const [koota, val] of Object.entries(data.koota_breakdown)) {
      html += `
        <tr>
          <td>${koota}</td>
          <td>${val.score}</td>
          <td>${val.max_score}</td>
        </tr>
      `;
    }
    html += `
            </tbody>
          </table>
        </div>
      </div>
    `;

    // üü¢ Additional Predictions
    html += `
      <div class="card shadow border-0">
        <div class="card-body">
          <h5 class="mb-3">üîÆ Additional Predictions</h5>
          <ul class="list-group">
    `;
    data.additional_predictions.forEach(pred => {
      let badgeClass = "secondary";
      if (pred.Nature === "Good") badgeClass = "success";
      else if (pred.Nature === "Bad") badgeClass = "danger";
      else if (pred.Nature === "Neutral") badgeClass = "warning";
      else if (pred.Nature === "Empty") badgeClass = "dark";

      html += `
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div>
            <strong>${pred.Name}</strong><br>
            <small>${pred.Description}</small>
          </div>
          <span class="badge bg-${badgeClass} rounded-pill">${pred.Nature}</span>
        </li>
      `;
    });
    html += `
          </ul>
        </div>
      </div>
    `;

    resultBox.innerHTML = html;

  } catch (error) {
    resultBox.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Error: ${error.message}</div>`;
  } finally {
    loader.style.display = "none";
  }
});
</script>

{% endblock %}
