{% extends "base.html" %}
{% block title %}Compatibility Report | Pathdarshak AI{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-lg border-0">
        <div class="card-body">
          <h3 class="text-center mb-4">üíû Compatibility Test</h3>
          
          <!-- Compatibility Form -->
          <form id="compatibility-form" class="row g-3">
            
            <h5 class="mt-3">Person 1</h5>
            <div class="col-md-4">
              <input type="text" name="name1" class="form-control" placeholder="Full Name" required>
            </div>
            <div class="col-md-4">
              <input type="date" name="date1" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="time" name="time1" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="text" name="place1" class="form-control" placeholder="Place" required>
            </div>

            <h5 class="mt-4">Person 2</h5>
            <div class="col-md-4">
              <input type="text" name="name2" class="form-control" placeholder="Full Name" required>
            </div>
            <div class="col-md-4">
              <input type="date" name="date2" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="time" name="time2" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="text" name="place2" class="form-control" placeholder="Place" required>
            </div>

            <div class="col-12 text-center mt-4">
              <button type="submit" class="btn btn-success px-5">Check Compatibility</button>
            </div>
          </form>

          <!-- Loader -->
          <div id="compatibility-loader" class="text-center my-4" style="display:none;">
            <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-dark">üîÆ Calculating compatibility...</p>
          </div>

          <!-- Result -->
          <div id="compatibility-result" class="mt-5"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function formatCompatibility(text) {
  const sections = { love: "", career: "", emotional: "", longterm: "", score: "" };

  // Split into lines
  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);

  lines.forEach(line => {
    const lower = line.toLowerCase();
    if (lower.includes("love") || lower.includes("relationship")) sections.love += line + "\n";
    else if (lower.includes("career") || lower.includes("partnership") || lower.includes("professional")) sections.career += line + "\n";
    else if (lower.includes("emotional")) sections.emotional += line + "\n";
    else if (lower.includes("long-term") || lower.includes("future") || lower.includes("potential")) sections.longterm += line + "\n";
    else if (lower.includes("compatibility") || lower.includes("overall")) sections.score += line + "\n";
  });

  // Extract numeric score
  let scoreValue = 0;
  const scoreMatch = sections.score.match(/(\d+)%/);
  if (scoreMatch) scoreValue = parseInt(scoreMatch[1], 10);

  // Determine progress bar color
  let barClass = "bg-danger";
  if (scoreValue >= 70) barClass = "bg-success";
  else if (scoreValue >= 40) barClass = "bg-warning text-dark";

  function formatText(t) {
    if (!t) return "No details provided.";
    return t
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // bold
      .replace(/^\*\s(.*)/gm, "<li>$1</li>")            // bullets
      .replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>")       // wrap bullets in <ul>
      .replace(/\n/g, "<br>");                          // line breaks
  }

  // Fallback if parsing fails
  if (Object.values(sections).filter(s => s).length <= 1) {
    return `<div class="card border-0 shadow bg-light">
              <div class="card-body">
                <h5 class="card-title">üîÆ Compatibility Report</h5>
                <div class="compatibility-text">${formatText(text)}</div>
              </div>
            </div>`;
  }

  return `
    <div class="row">
      <div class="col-12 mb-3">
        <div class="card border-0 shadow bg-light"><div class="card-body">
          <h5 class="card-title">üíû Love & Relationship</h5>
          <div class="compatibility-text">${formatText(sections.love)}</div>
        </div></div>
      </div>
      <div class="col-12 mb-3">
        <div class="card border-0 shadow bg-light"><div class="card-body">
          <h5 class="card-title">üíº Career & Partnership</h5>
          <div class="compatibility-text">${formatText(sections.career)}</div>
        </div></div>
      </div>
      <div class="col-12 mb-3">
        <div class="card border-0 shadow bg-light"><div class="card-body">
          <h5 class="card-title">üåô Emotional Connection</h5>
          <div class="compatibility-text">${formatText(sections.emotional)}</div>
        </div></div>
      </div>
      <div class="col-12 mb-3">
        <div class="card border-0 shadow bg-light"><div class="card-body">
          <h5 class="card-title">‚è≥ Long-term Potential</h5>
          <div class="compatibility-text">${formatText(sections.longterm)}</div>
        </div></div>
      </div>
      <div class="col-12">
        <div class="card border-0 shadow bg-warning">
          <div class="card-body text-center">
            <h4 class="card-title">‚ú® Overall Compatibility</h4>
            <p class="fw-bold fs-5">${sections.score || "Score not found"}</p>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar ${barClass} fw-bold" role="progressbar"
                style="width: ${scoreValue}%;"
                aria-valuenow="${scoreValue}" aria-valuemin="0" aria-valuemax="100">
                ${scoreValue}%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

document.getElementById("compatibility-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const loader = document.getElementById("compatibility-loader");
  const resultBox = document.getElementById("compatibility-result");
  resultBox.innerHTML = "";
  loader.style.display = "block";

  const formData = new FormData(this);
  const payload = Object.fromEntries(formData.entries());

  const person1 = { Name: payload["name1"], Date: payload["date1"], Time: payload["time1"], Place: payload["place1"] };
  const person2 = { Name: payload["name2"], Date: payload["date2"], Time: payload["time2"], Place: payload["place2"] };

  try {
    const response = await fetch("{% url 'compatibility' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ person1, person2 }),
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    resultBox.innerHTML = formatCompatibility(data['text']);
  } catch (error) {
    resultBox.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Error: ${error.message}</div>`;
  } finally {
    loader.style.display = "none";
  }
});
</script>
{% endblock %}
