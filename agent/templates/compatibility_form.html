{% extends "base.html" %}
{% block title %}Compatibility Report | Pathdarshak AI{% endblock %}

{% block content %}
<style>
  /* Custom styles matching the theme: mystical, attractive, responsive */
  .compatibility-card {
    background: linear-gradient(135deg, #1a1a2e, #16213e); /* Starry night gradient */
    border-radius: 15px;
    overflow: hidden;
    position: relative;
    color: #f8f9fa; /* Light text */
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }
  .compatibility-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('https://example.com/starry-bg.png') no-repeat center/cover; /* Optional starry image */
    opacity: 0.1;
    pointer-events: none;
  }
  .shimmer {
    animation: shimmer 2s infinite;
    background: linear-gradient(90deg, #ffffff 0%, #a8a8a8 50%, #ffffff 100%);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    color: rgba(255, 255, 255, 0.8); /* Fallback */
  }
  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  .form-label {
    color: #e0e0e0;
    font-weight: 500;
  }
  .form-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #ffffff;
    border-radius: 8px;
    transition: border-color 0.3s, background 0.3s;
  }
  .form-control:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: #8f94fb;
    box-shadow: 0 0 0 0.2rem rgba(143, 148, 251, 0.25);
  }
  .btn-success {
    background: linear-gradient(135deg, #4e54c8, #8f94fb);
    border: none;
    border-radius: 8px;
    font-weight: 600;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(78, 84, 200, 0.4);
  }
  #compatibility-result .card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: #f8f9fa;
  }
  #compatibility-result .progress {
    background: rgba(255, 255, 255, 0.1);
    height: 25px;
    border-radius: 12px;
  }
  #compatibility-result .progress-bar {
    font-weight: bold;
  }
  /* Responsiveness */
  @media (max-width: 576px) {
    .row.g-3 > div {
      margin-bottom: 1rem;
    }
    h3 { font-size: 1.75rem; }
    h5 { font-size: 1.25rem; }
  }
</style>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-10 col-md-12">
      <div class="card border-0 compatibility-card position-relative">
        <div class="card-body p-4 p-md-5">
          <h3 class="text-center shimmer mb-4">üíû Compatibility Test</h3>
          
          <!-- Compatibility Form: Improved labels, placeholders -->
          <form id="compatibility-form" class="row g-3">
            <h5 class="mt-3 shimmer">Person 1 Details</h5>
            <div class="col-md-4">
              <label for="name1" class="form-label">Full Name</label>
              <input type="text" id="name1" name="name1" class="form-control" placeholder="e.g., John Doe" required value="{{name1}}">
            </div>
            <div class="col-md-4">
              <label for="date1" class="form-label">Birth Date</label>
              <input type="date" id="date1" name="date1" class="form-control" required value="{{date1}}">
            </div>
            <div class="col-md-2">
              <label for="time1" class="form-label">Birth Time</label>
              <input type="time" id="time1" name="time1" class="form-control" required value="{{time1}}">
            </div>
            <div class="col-md-2">
              <label for="place1" class="form-label">Birth Place</label>
              <input type="text" id="place1" name="place1" class="form-control" placeholder="e.g., New York" required value="{{place1}}">
            </div>

            <h5 class="mt-4 shimmer">Person 2 Details</h5>
            <div class="col-md-4">
              <label for="name2" class="form-label">Full Name</label>
              <input type="text" id="name2" name="name2" class="form-control" placeholder="e.g., Jane Smith" required>
            </div>
            <div class="col-md-4">
              <label for="date2" class="form-label">Birth Date</label>
              <input type="date" id="date2" name="date2" class="form-control" required>
            </div>
            <div class="col-md-2">
              <label for="time2" class="form-label">Birth Time</label>
              <input type="time" id="time2" name="time2" class="form-control" required>
            </div>
            <div class="col-md-2">
              <label for="place2" class="form-label">Birth Place</label>
              <input type="text" id="place2" name="place2" class="form-control" placeholder="e.g., Los Angeles" required>
            </div>

            <div class="col-12 text-center mt-4">
              <button type="submit" class="btn btn-success px-5">Check Compatibility ‚ú®</button>
            </div>
          </form>

          <!-- Loader: Enhanced with shimmer-like animation if desired -->
          <div id="compatibility-loader" class="text-center my-4" style="display:none;">
            <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">üîÆ Calculating cosmic compatibility...</p>
          </div>

          <!-- Result: Will be populated by JS -->
          <div id="compatibility-result" class="mt-5"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function formatCompatibility(text) {
  // Normalize text: remove extra spaces, handle markdown
  text = text.replace(/\r\n/g, '\n').trim();

  // Extract sections using more flexible matching
  const sections = {
    love: extractSection(text, /1\.\s*Love & Relationship/i, /2\.\s*Career\/Partnership/i),
    career: extractSection(text, /2\.\s*Career\/Partnership/i, /3\.\s*Emotional Connection/i),
    emotional: extractSection(text, /3\.\s*Emotional Connection/i, /4\.\s*Long-term Potential/i),
    longterm: extractSection(text, /4\.\s*Long-term Potential/i, /Overall Compatibility Score/i),
    score: extractSection(text, /Overall Compatibility Score/i, /$/),
  };

  // Extract snapshot if present (optional)
  const snapshot = extractSection(text, /Astrological Snapshot:/i, /Compatibility Analysis:/i);

  // Extract numeric score from score section
  let scoreValue = 0;
  const scoreMatch = (sections.score || '').match(/(\d+)%/);
  if (scoreMatch) scoreValue = parseInt(scoreMatch[1], 10);

  // Determine progress bar color
  let barClass = "bg-danger";
  if (scoreValue >= 70) barClass = "bg-success";
  else if (scoreValue >= 40) barClass = "bg-warning text-dark";

  function extractSection(text, startRegex, endRegex) {
    const startMatch = text.match(startRegex);
    if (!startMatch) return '';
    const startIndex = startMatch.index + startMatch[0].length;
    const endMatch = text.slice(startIndex).match(endRegex);
    const endIndex = endMatch ? endMatch.index : text.length - startIndex;
    return text.slice(startIndex, startIndex + endIndex).trim();
  }

  function formatText(t) {
    if (!t) return '<p>No specific insights available for this section.</p>';
    return t
      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") // bold
      .replace(/^\*\s+(.*)/gm, "<li>$1</li>")           // bullets (including sub-bullets)
      .replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>")       // wrap in ul
      .replace(/\n\n/g, "</p><p>")                      // paragraphs
      .replace(/\n/g, "<br>");                          // line breaks
  }

  let html = '';

  // Add Snapshot if present
  if (snapshot) {
    html += `
      <div class="card mb-4">
        <div class="card-body">
          <h5 class="card-title shimmer">üåü Astrological Snapshot</h5>
          <div class="compatibility-text"><p>${formatText(snapshot)}</p></div>
        </div>
      </div>
    `;
  }

  // Always render the fixed sections, even if empty
  html += `
    <div class="row">
      <div class="col-12 mb-3">
        <div class="card"><div class="card-body">
          <h5 class="card-title shimmer">üíû Love & Relationship</h5>
          <div class="compatibility-text"><p>${formatText(sections.love)}</p></div>
        </div></div>
      </div>
      <div class="col-12 mb-3">
        <div class="card"><div class="card-body">
          <h5 class="card-title shimmer">üíº Career/Partnership</h5>
          <div class="compatibility-text"><p>${formatText(sections.career)}</p></div>
        </div></div>
      </div>
      <div class="col-12 mb-3">
        <div class="card"><div class="card-body">
          <h5 class="card-title shimmer">üåô Emotional Connection</h5>
          <div class="compatibility-text"><p>${formatText(sections.emotional)}</p></div>
        </div></div>
      </div>
      <div class="col-12 mb-3">
        <div class="card"><div class="card-body">
          <h5 class="card-title shimmer">‚è≥ Long-term Potential</h5>
          <div class="compatibility-text"><p>${formatText(sections.longterm)}</p></div>
        </div></div>
      </div>
      <div class="col-12">
        <div class="card bg-warning">
          <div class="card-body text-center">
            <h4 class="card-title shimmer">‚ú® Overall Compatibility Score</h4>
            <p class="fw-bold fs-5">${formatText(sections.score) || "Score not available"}</p>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar ${barClass} fw-bold" role="progressbar"
                style="width: ${scoreValue}%;"
                aria-valuenow="${scoreValue}" aria-valuemin="0" aria-valuemax="100">
                ${scoreValue}%
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;

  return html;
}

document.getElementById("compatibility-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const loader = document.getElementById("compatibility-loader");
  const resultBox = document.getElementById("compatibility-result");
  resultBox.innerHTML = "";
  loader.style.display = "block";

  const formData = new FormData(this);
  const payload = Object.fromEntries(formData.entries());

  const person1 = { Name: payload["name1"], Date: payload["date1"], Time: payload["time1"], Place: payload["place1"] };
  const person2 = { Name: payload["name2"], Date: payload["date2"], Time: payload["time2"], Place: payload["place2"] };

  try {
    const response = await fetch("{% url 'compatibility' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
      body: JSON.stringify({ person1, person2 }),
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    resultBox.innerHTML = formatCompatibility(data['text']);
  } catch (error) {
    resultBox.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Error: ${error.message}</div>`;
  } finally {
    loader.style.display = "none";
  }
});
</script>
{% endblock %}