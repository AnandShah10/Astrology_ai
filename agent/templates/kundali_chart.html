{% extends "base.html" %}
{% block title %}Kundali Report | Astro AI{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-lg border-0">
        <div class="card-body">
          <h3 class="text-center mb-4">üåå Kundali (Vedic Birth Chart)</h3>
          
          <!-- Kundali Form -->
          <form id="kundali-form" class="row g-3">
            <h5 class="mt-3">Person Details</h5>
            <div class="col-md-4">
              <input type="text" name="name" class="form-control" placeholder="Full Name" value="Unknown">
            </div>
            <div class="col-md-4">
              <input type="date" name="date" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="time" name="time" class="form-control" required>
            </div>
            <div class="col-md-2">
              <input type="text" name="place" class="form-control" placeholder="Place" required>
            </div>
            <div class="col-12 text-center mt-4">
              <button type="submit" class="btn btn-success px-5">Generate Kundali</button>
            </div>
          </form>

          <!-- Loader -->
          <div id="kundali-loader" class="text-center my-4" style="display:none;">
            <div class="spinner-border text-warning" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-dark">üîÆ Generating Kundali...</p>
          </div>

          <!-- Result -->
          <div id="kundali-result" class="mt-5"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function formatKundali(data) {
    try {
      // Ensure data is parsed JSON
      const result = typeof data === 'string' ? JSON.parse(data) : data;

      // Extract fields
      const name = result.name || 'Unknown';
      const birthTime = result.birth_time || 'Unknown';
      const place = result.place || 'Unknown';
      const planetData = result.planet_data || {};
      const houseData = result.house_data || {};
      const zodiacData = result.zodiac_data || {};

      // Planet data table
      let planetTable = `
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>Planet</th>
              <th>Zodiac Sign</th>
              <th>Longitude</th>
              <th>Shadbala</th>
              <th>Retrograde</th>
            </tr>
          </thead>
          <tbody>
      `;
      for (const [planet, details] of Object.entries(planetData)) {
        planetTable += `
          <tr>
            <td>${planet}</td>
            <td>${details.sign}</td>
            <td>${details.longitude.toFixed(2)}¬∞</td>
            <td>${details.shadbala.toFixed(2)}</td>
            <td>${details.is_retrograde ? 'Yes' : 'No'}</td>
          </tr>
        `;
      }
      planetTable += '</tbody></table>';

      // House data table
      let houseTable = `
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>House</th>
              <th>Zodiac Sign</th>
              <th>Lord Planet</th>
            </tr>
          </thead>
          <tbody>
      `;
      for (const [house, details] of Object.entries(houseData)) {
        houseTable += `
          <tr>
            <td>${house}</td>
            <td>${details.sign}</td>
            <td>${details.lord}</td>
          </tr>
        `;
      }
      houseTable += '</tbody></table>';

      // Zodiac data table
      let zodiacTable = `
        <table class="table table-bordered mt-3">
          <thead class="table-light">
            <tr>
              <th>Zodiac Sign</th>
              <th>Ruling Planet</th>
              <th>Element</th>
            </tr>
          </thead>
          <tbody>
      `;
      for (const [sign, details] of Object.entries(zodiacData)) {
        zodiacTable += `
          <tr>
            <td>${sign}</td>
            <td>${details.ruling_planet}</td>
            <td>${details.element}</td>
          </tr>
        `;
      }
      zodiacTable += '</tbody></table>';

      // Full HTML output
      return `
        <div class="row">
          <div class="col-12 mb-3">
            <div class="card border-0 shadow bg-light">
              <div class="card-body">
                <h4 class="card-title">üåü Kundali for ${name}</h4>
                <p><strong>Birth Time:</strong> ${birthTime}</p>
                <p><strong>Place:</strong> ${place}</p>
              </div>
            </div>
          </div>
          <div class="col-12 mb-3">
            <div class="card border-0 shadow bg-light">
              <div class="card-body">
                <h5 class="card-title">ü™ê Planetary Positions</h5>
                ${planetTable}
              </div>
            </div>
          </div>
          <div class="col-12 mb-3">
            <div class="card border-0 shadow bg-light">
              <div class="card-body">
                <h5 class="card-title">üèõ House Details</h5>
                ${houseTable}
              </div>
            </div>
          </div>
          <div class="col-12 mb-3">
            <div class="card border-0 shadow bg-light">
              <div class="card-body">
                <h5 class="card-title">üåç Zodiac Signs</h5>
                ${zodiacTable}
              </div>
            </div>
          </div>
        </div>
      `;
    } catch (error) {
      return `
        <div class="alert alert-danger">
          ‚ö†Ô∏è Error processing Kundali data: ${error.message}
        </div>
      `;
    }
  }

  document.getElementById("kundali-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const loader = document.getElementById("kundali-loader");
    const resultBox = document.getElementById("kundali-result");
    resultBox.innerHTML = "";
    loader.style.display = "block";

    const formData = new FormData(this);
    const payload = Object.fromEntries(formData.entries());
    const birth_data = {
      'Name': payload['name'],
      'Date': payload['date'].split('-').reverse().join('/'), // Convert YYYY-MM-DD to DD/MM/YYYY
      'Time': payload['time'],
      'place': payload['place']
    };

    try {
      const response = await fetch("{% url 'kundali' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify(birth_data),
      });

      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }

      const data = await response.json();
      const html = formatKundali(data);
      resultBox.innerHTML = html;
    } catch (error) {
      resultBox.innerHTML = `<div class="alert alert-danger">‚ö†Ô∏è Error: ${error.message}</div>`;
    } finally {
      loader.style.display = "none";
    }
  });
</script>
{% endblock %}