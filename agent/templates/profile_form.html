{% extends "base.html" %}
{% block content %}
<div class="profile-bg">
  <div class="astro-card p-4 p-md-5 rounded-4 text-center">
    <div class="mb-4">
      <h2 class="title">Your Birth Details</h2>
      <p class="subtitle">Your cosmic journey begins here ✨</p>
    </div>

    <form method="post" action="{% url 'save_profile' %}" class="text-start">
      {% csrf_token %}
      <!-- Name -->
      <div class="form-group mb-4">
        <label class="floating-label">
          <i class="bi bi-person"></i>
          {{ form.name }}
          <span>First Name</span>
        </label>
      </div>

      <!-- Birth Date -->
      <div class="form-group mb-4">
        <label class="floating-label">
          <i class="bi bi-calendar-event"></i>
          {{ form.birth_date }}
          <span>Date of Birth</span>
        </label>
        {% for error in form.birth_date.errors %}
            {{ error }}
            {% endfor %}
      </div>

      <!-- Birth Time -->
      <div class="form-group mb-4">
        <label class="floating-label">
          <i class="bi bi-clock"></i>
          {{ form.birth_time }}
          <span>Time of Birth</span>
        </label>
        {% for error in form.birth_time.errors %}
            {{ error }}
            {% endfor %}
      </div>

      <!-- Birth Place -->
      <div class="form-group mb-4 position-relative">
        <label class="floating-label">
          <i class="bi bi-geo-alt"></i>
          {{ form.birth_place }}
          <span>Place of Birth</span>
          <!-- Loader -->
          <div id="inputLoader" class="input-loader"></div>

          <!-- Location button -->
          <button type="button" class="btn-location bi bi-geo-alt-fill" onclick="getLocation()"></button>

          <!-- Suggestions Dropdown -->
          <div id="suggestions" class="dropdown-menu custom-dropdown"></div>
        </label>
        {% for error in form.birth_place.errors %}
            {{ error }}
            {% endfor %}
                  <p class="alert text-danger">{{ error }}</p>

        <!-- Hidden fields for lat/lon -->
        <input type="hidden" name="latitude" id="latitude">
        <input type="hidden" name="longitude" id="longitude">
      </div>
      
      <!-- Gender -->
      <div class="form-group mb-4">
        <label class="floating-label">
          <i class="bi bi-person"></i>
          {{ form.gender }}
          <span>Gender</span>
        </label>
      </div>

      <!-- Astrology System -->
      <div class="form-group mb-4">
        <label class="floating-label">
          <i class="bi bi-stars"></i>
          {{ form.system }}
          <span>Astrology System</span>
        </label>
      </div>

      <!-- Submit Button -->
      <div class="d-flex justify-content-center">
        <button type="submit" class="btn-submit">✨ Save My Profile</button>
      </div>
    </form>
  </div>
</div>

<style>
/* Background */
.profile-bg {
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  overflow: hidden;
}

/* Card */
.astro-card {
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(20px);
  border-radius: 1.5rem;
  width: 100%;
  max-width: 480px;
  color: #fff;
  box-shadow: 0 0 30px rgba(255, 193, 7, 0.3);
  animation: fadeIn 1s ease;
}
.astro-card:hover {
  box-shadow: 0 0 50px rgba(255, 193, 7, 0.6);
}

/* Title */
.title {
  font-size: 2rem;
  background: linear-gradient(90deg, #FFC107, #FF8C00);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-weight: 700;
  letter-spacing: 1px;
}
.subtitle {
  font-size: 0.95rem;
  color: #f0e68c;
}

/* Floating Label */
.floating-label {
  position: relative;
  display: block;
  width: 100%;
}
.floating-label i {
  position: absolute;
  top: 50%;
  left: 15px;
  transform: translateY(-50%);
  color: #FFC107;
  font-size: 1.2rem;
}
.floating-label input,
.floating-label select {
  width: 100%;
  padding: 0.9rem 1rem 0.9rem 2.8rem;
  border-radius: 0.75rem;
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.05);
  color: #fff;
  font-size: 1rem;
  transition: all 0.3s ease;
}
.floating-label select option {
  background: #111;
  color: #fff;
  padding: 0.5rem;
}
.floating-label span {
  position: absolute;
  top: 50%;
  left: 2.8rem;
  transform: translateY(-50%);
  font-size: 0.9rem;
  color: #bbb;
  transition: 0.3s ease;
  pointer-events: none;
}
.floating-label input:focus,
.floating-label select:focus {
  border-color: #FFC107;
  box-shadow: 0 0 20px rgba(255, 193, 7, 0.5);
  outline: none;
}
.floating-label input:focus + span,
.floating-label input:not(:placeholder-shown) + span,
.floating-label select:focus + span,
.floating-label select:not([value=""]) + span {
  top: -8px;
  left: 2.5rem;
  font-size: 0.75rem;
  color: #FFC107;
  background: rgba(0,0,0,0.6);
  padding: 0 5px;
  border-radius: 4px;
}

/* Dropdown */
.custom-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 2.8rem;
  right: 0;
  z-index: 1050;
  max-height: 200px;
  overflow-y: auto;
  background: #111;
  border: 1px solid rgba(255, 193, 7, 0.4);
  border-radius: 0.5rem;
  box-shadow: 0 0 15px rgba(255, 193, 7, 0.3);
}
.custom-dropdown.show { display: block; animation: fadeIn 0.2s ease; }
.custom-dropdown .dropdown-item {
  padding: 0.7rem 1rem;
  font-size: 0.95rem;
  color: #fff;
  cursor: pointer;
}
.custom-dropdown .dropdown-item:hover,
.custom-dropdown .dropdown-item.active {
  background: linear-gradient(90deg, rgba(255,193,7,0.5), rgba(255,140,0,0.5));
  color: #fff;
}
/* Thin + glowing scrollbar */
.custom-dropdown::-webkit-scrollbar {
  width: 6px;
}

.custom-dropdown::-webkit-scrollbar-track {
  background: transparent; /* invisible track */
}

.custom-dropdown::-webkit-scrollbar-thumb {
  background: rgba(255, 193, 7, 0.4); /* soft golden */
  border-radius: 10px;
  transition: background 0.3s ease, opacity 0.3s ease;
  opacity: 0; /* hidden by default */
}

.custom-dropdown:hover::-webkit-scrollbar-thumb,
.custom-dropdown:active::-webkit-scrollbar-thumb {
  opacity: 1; /* show on hover/scroll */
  background: rgba(255, 193, 7, 0.8); /* brighter gold */
}

/* Firefox support */
.custom-dropdown {
  scrollbar-width: thin;
  scrollbar-color: rgba(255,193,7,0.6) transparent;
}


/* Loader */
.input-loader {
  position: absolute;
  right: 40px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  border: 2px solid rgba(255, 193, 7, 0.3);
  border-top: 2px solid #FFC107;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  display: none;
}
@keyframes spin {
  0% { transform: translateY(-50%) rotate(0deg); }
  100% { transform: translateY(-50%) rotate(360deg); }
}

/* Location button */
.btn-location {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  font-size: 1.3rem;
  cursor: pointer;
  color: #FFC107;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Responsive */
@media (max-width: 576px) {
  .title { font-size: 1.6rem; }
  .astro-card { padding: 2rem; }
}
.btn-submit { background: linear-gradient(90deg, #FFC107, #FF8C00); color: #fff; padding: 0.9rem 2.2rem; border: none; border-radius: 0.75rem; font-size: 1.1rem; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 0 20px rgba(255, 193, 7, 0.4); }
 .btn-submit:hover { transform: scale(1.05); background: linear-gradient(90deg, #FF8C00, #FFC107); box-shadow: 0 0 30px rgba(255, 193, 7, 0.6); }
</style>

<script>
const input = document.querySelector('[name="birth_place"]');
const suggestions = document.getElementById("suggestions");
const loader = document.getElementById("inputLoader");
const latField = document.getElementById("latitude");
const lonField = document.getElementById("longitude");

let selectedIndex = -1;
let debounceTimer = null;

// Debounced search
input.addEventListener("input", function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();
    debounceTimer = setTimeout(() => fetchSuggestions(query), 300);
});

function fetchSuggestions(query) {
    suggestions.innerHTML = "";
    suggestions.classList.remove("show");
    selectedIndex = -1;

    if (!query || query.length < 3) return;

    loader.style.display = "block";

    fetch(`https://photon.komoot.io/api/?q=${query}&limit=6`)
        .then(res => res.json())
        .then(data => {
            suggestions.innerHTML = "";
            data.features.forEach((place, index) => {
                let city = place.properties.city || "";
                let country = place.properties.country || "";
                let name = place.properties.name || "";
                let display = `${name}${city ? ", " + city : ""}${country ? ", " + country : ""}`;

                let option = document.createElement("div");
                option.classList.add("dropdown-item");
                option.innerHTML = display.replace(new RegExp(`(${query})`, "i"), "<strong>$1</strong>");

                option.addEventListener("click", () => {
                    input.value = display;
                    latField.value = place.geometry.coordinates[1];
                    lonField.value = place.geometry.coordinates[0];
                    suggestions.innerHTML = "";
                    suggestions.classList.remove("show");
                });

                suggestions.appendChild(option);
            });

            let items = suggestions.querySelectorAll(".dropdown-item");
            if (items.length > 0) {
                selectedIndex = 0;
                updateHighlight(items);
                suggestions.classList.add("show");
            }
        })
        .finally(() => loader.style.display = "none");
}

// Keyboard navigation
input.addEventListener("keydown", function(e) {
    let items = suggestions.querySelectorAll(".dropdown-item");
    if (!items.length) return;

    if (e.key === "ArrowDown") {
        e.preventDefault();
        selectedIndex = (selectedIndex + 1) % items.length;
        updateHighlight(items);
    } else if (e.key === "ArrowUp") {
        e.preventDefault();
        selectedIndex = (selectedIndex - 1 + items.length) % items.length;
        updateHighlight(items);
    } else if (e.key === "Enter") {
        e.preventDefault();
        if (selectedIndex >= 0 && items[selectedIndex]) {
            items[selectedIndex].click();
        }
    } else if (e.key === "Escape") {
        suggestions.classList.remove("show");
    }
});

function updateHighlight(items) {
    items.forEach((item, index) => {
        item.classList.toggle("active", index === selectedIndex);
        if (index === selectedIndex) item.scrollIntoView({ block: "nearest" });
    });
}

// 📍 Use Current Location
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
        alert("Geolocation not supported");
    }
}

function showPosition(position) {
    let lat = position.coords.latitude;
    let lon = position.coords.longitude;

    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
        .then(res => res.json())
        .then(data => {
            input.value = data.display_name;
            latField.value = lat;
            lonField.value = lon;
            suggestions.innerHTML = "";
            suggestions.classList.remove("show");
        });
}

function showError(error) {
    alert("Error fetching location: " + error.message);
}

// Close dropdown when clicking outside
document.addEventListener("click", function(e) {
    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.classList.remove("show");
        selectedIndex = -1;
    }
});
</script>
{% endblock %}
